# 钉钉机器人事件订阅配置指南

## 问题现象

WebSocket 连接成功，但收不到机器人消息，只能收到心跳（ping）消息。

## 原因

钉钉开放平台需要配置**事件订阅**，才能将机器人消息推送到 Stream 连接。

## 解决步骤

### 1. 进入事件订阅配置

1. 登录 [钉钉开放平台](https://open-dev.dingtalk.com/)
2. 选择你的应用
3. 点击左侧菜单：**开发配置** → **事件订阅**

### 2. 配置推送方式

在「事件订阅」页面：

1. **推送方式**：选择 **「Stream 模式推送」**
2. 点击「已完成接入，验证连接通道」（如果显示）
3. 确认连接状态为「已连接」

### 3. 订阅机器人消息事件

点击「订阅事件」按钮，添加以下事件：

#### 必须订阅的事件：

**机器人消息相关：**
- `机器人接收消息` - 当用户 @机器人发送消息时触发
- 事件类型：`chat_update_title` 或 `robot_chat_message`

**具体操作：**
1. 在事件列表中搜索「机器人」
2. 找到「机器人接收消息」或类似事件
3. 勾选并添加
4. 点击「保存」

### 4. 验证配置

配置完成后：

1. 在钉钉群聊中 @机器人
2. 发送测试消息
3. 查看应用日志，应该能看到：
   ```
   DingTalkStreamClient: 收到消息: {"type":"CALLBACK",...}
   DingTalkStreamClient: 处理回调消息，完整消息: ...
   ```

## 常见事件类型

根据钉钉文档，机器人相关的事件可能包括：

| 事件名称 | 事件类型 | 说明 |
|---------|---------|------|
| 机器人接收消息 | `chat_update_title` | 用户 @机器人发送消息 |
| 群会话变更 | `chat_update` | 群信息变更 |
| 机器人被添加到群 | `chat_add_member` | 机器人被添加到群聊 |

## 如果找不到事件订阅选项

### 方案 1：检查应用类型

确认你创建的是「企业内部应用」，而不是「第三方应用」。企业内部应用才支持 Stream 模式。

### 方案 2：检查机器人配置

1. 应用详情 → **应用功能** → **机器人**
2. 确认机器人已开启
3. 查看机器人配置中是否有「消息接收」相关设置

### 方案 3：使用旧版 Webhook 模式（不推荐）

如果实在无法配置 Stream 模式，可以考虑使用 HTTP 推送（Webhook）模式，但需要：
- 公网可访问的服务器
- 配置回调 URL
- 处理签名验证

## 调试技巧

### 1. 查看订阅状态

在代码中添加日志，查看实际订阅的 topic：

```java
Log.d(TAG, "Stream 请求: " + requestJson);
```

应该看到类似：
```json
{
  "clientId": "...",
  "clientSecret": "...",
  "subscriptions": [
    {"type": "CALLBACK", "topic": "/v1.0/im/bot/messages/get"},
    {"type": "CALLBACK", "topic": "*"}
  ]
}
```

### 2. 测试消息格式

在钉钉群聊中：
1. @机器人
2. 发送简单文本：「测试」
3. 查看日志中的消息格式

### 3. 检查权限

确认应用权限中包括：
- ✅ 企业内机器人发送消息
- ✅ 机器人消息接收
- ✅ 读取群会话信息

## 参考文档

- [钉钉 Stream 模式文档](https://open.dingtalk.com/document/orgapp/stream-mode-overview)
- [钉钉事件订阅](https://open.dingtalk.com/document/orgapp/event-subscription-overview)
- [机器人消息接收](https://open.dingtalk.com/document/orgapp/receive-message)

## 如果仍然无法解决

请提供以下信息：

1. 钉钉开放平台的截图：
   - 事件订阅页面
   - 机器人配置页面
   - 权限管理页面

2. 应用日志中的完整消息（包括 ping 和其他消息）

3. 钉钉群聊中发送消息后的截图

这样我可以帮你进一步诊断问题。
