# 重要：必须配置事件订阅才能接收消息

## 问题原因

钉钉官方 SDK 不支持 Android（依赖 JVM 特性），所以我们使用自定义实现。

但是，**无论使用哪种方式，都必须在钉钉开放平台配置事件订阅**，否则无法接收机器人消息！

## 必须完成的配置

### 1. 登录钉钉开放平台

访问：https://open-dev.dingtalk.com/

### 2. 进入你的应用

选择你创建的企业内部应用

### 3. 配置事件订阅（关键步骤！）

1. 点击左侧菜单：**开发配置** → **事件订阅**

2. **推送方式**：
   - 选择「Stream 模式推送」
   - 点击「已完成接入，验证连接通道」

3. **订阅事件**：
   - 点击「订阅事件」按钮
   - 搜索「机器人」
   - 找到并勾选：**「机器人接收消息」**
   - 点击保存

### 4. 确认权限

进入「权限管理」，确认已开启：
- ✅ 企业内机器人发送消息
- ✅ 机器人消息接收
- ✅ 上传媒体文件

## 现在可以测试了

1. **重新构建应用**：
   ```bash
   gradlew.bat assembleDebug
   gradlew.bat installDebug
   ```

2. **启动服务**：
   - 打开应用 → 菜单 → 远程查看
   - 填入配置 → 保存 → 启动服务
   - 等待连接状态显示「已连接」

3. **测试消息接收**：
   - 在钉钉群聊中 @机器人
   - 发送「录制」
   - 查看应用日志，应该能看到：
     ```
     DingTalkStreamClient: 收到消息: {"type":"CALLBACK",...}
     DingTalkStreamClient: 处理回调消息...
     DingTalkCommandReceiver: 收到录制指令
     ```

## 如果还是收不到消息

### 检查清单：

1. ✅ 事件订阅已配置（Stream 模式）
2. ✅ 已订阅「机器人接收消息」事件
3. ✅ 机器人已添加到钉钉群聊
4. ✅ 应用显示「已连接」状态
5. ✅ 在群聊中 @机器人（必须 @）
6. ✅ 发送的是文本消息「录制」

### 查看日志：

打开应用日志面板，查找：
- `DingTalkStreamClient: 收到消息` - 如果有这个，说明连接正常
- `DingTalkStreamClient: 处理回调消息` - 如果有这个，说明收到了 CALLBACK 类型消息
- `DingTalkCommandReceiver: 收到录制指令` - 如果有这个，说明指令解析成功

### 常见问题：

**只收到 ping 消息，没有其他消息**
→ 说明事件订阅没有配置，或者没有订阅「机器人接收消息」事件

**收到 CALLBACK 消息，但没有触发录制**
→ 消息格式可能不匹配，把完整的日志发给我分析

**完全没有任何消息**
→ 检查 ClientId 和 ClientSecret 是否正确

## 参考文档

- [事件订阅详细配置](DINGTALK_EVENT_SUBSCRIPTION.md)
- [故障排查指南](DINGTALK_TROUBLESHOOTING.md)
- [使用指南](DINGTALK_GUIDE.md)
